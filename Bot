import requests
import telebot
from telebot import types
from flask import Flask
from threading import Thread
import time
import logging

app = Flask('')
bot = telebot.TeleBot("7384979872:AAGYI3nKG3MCTHHbiYvWoa223ulFLUqGua0")  # Ø§Ø³ØªØ¨Ø¯Ù„ TOKEN Ø¨Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¨ÙˆØª

# Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
admin_id = '6919778644'

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ IDs Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
allowed_ids = ['6919778644', '5854455083', '1484963611', '5379780537', '6186245101']
user_activation = {}  # Ù‚Ø§Ù…ÙˆØ³ Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

@bot.message_handler(commands=["start"])
def startt(message):
    if str(message.from_user.id) not in allowed_ids:
        bot.reply_to(message, "âŒ Ø£Ù†Øª ØºÙŠØ± Ù…ÙÙˆØ¶ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª.")
        return
    user_id = message.from_user.id
    first_name = message.from_user.first_name
    last_name = message.from_user.last_name
    username = message.from_user.username
    omar = f"""HI ğŸ‘‹ {first_name}
    
Ø§Ø¨Ø¹Ø« Ù†Ù…ÙŠØ±ÙˆÙƒ ÙˆØ§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„ Ù…Ø±Ø§Ùƒ Ø®Ø§Ø³Ø± ÙˆÙ„Ùˆ  âœ‰ï¸"""
    response = f"User info:\nID: {user_id}\nName: {first_name} {last_name}\nUsername: @{username}"
    bot.send_message(chat_id=message.chat.id, text=omar)
    bot.send_message(chat_id=admin_id, text=response)

@bot.message_handler(commands=["A"])
def add_user(message):
    if str(message.from_user.id) != admin_id:
        bot.reply_to(message, "âŒ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.")
        return
    msg = bot.reply_to(message, "ğŸ“¥ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡.")
    bot.register_next_step_handler(msg, process_user_id)

def process_user_id(message):
    try:
        new_user_id = message.text
        if new_user_id not in allowed_ids:
            allowed_ids.append(new_user_id)
            msg = bot.reply_to(message, f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ ID: {new_user_id}\nğŸ“… ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ø§Ù„Ø³Ø§Ø¹Ø©.")
            bot.register_next_step_handler(msg, process_activation_duration, new_user_id)
        else:
            bot.reply_to(message, "âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.")
    except IndexError:
        bot.reply_to(message, "âŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.")

def process_activation_duration(message, user_id):
    try:
        duration_hours = int(message.text)
        user_activation[user_id] = duration_hours
        bot.reply_to(message, f"â³ Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ID: {user_id} Ù‡ÙŠ {duration_hours} Ø³Ø§Ø¹Ø©.")
    except ValueError:
        bot.reply_to(message, "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø©.")

@bot.message_handler(commands=["S"])
def stop_bot(message):
    if str(message.from_user.id) == admin_id:
        bot.reply_to(message, "ğŸ›‘ Ø§Ù„Ø¨ÙˆØª Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø§Ù„Ø¢Ù†.")
        bot.stop_polling()

@bot.message_handler(func=lambda message: True)
def get(message):
    if str(message.from_user.id) not in allowed_ids:
        return
    first_name = message.from_user.first_name
    user_id = message.from_user.id
    global mobile_number
    mobile_number = message.text
    r1 = requests.get("https://github.com/Omarbakhti/Amar2/blob/main/dina.txt").text

    bot.send_message(chat_id=admin_id, text=f"Ø§Ù„Ù…Ø±Ø³Ù„: {user_id}\n{mobile_number}\n{first_name}") 
    url = "https://ibiza.ooredoo.dz/auth/realms/ibiza/protocol/openid-connect/token"
    headers = {
        "Content-Type": "application/x-www-form-urlencoded"
    }
    payload = {
        "client_id": "ibiza-app",
        "grant_type": "password",
        "mobile-number": mobile_number,
        "language": "AR"
    }

    response1 = requests.post(url, headers=headers, data=payload)

    if 'ROOGY' in response1.text:
        message_bitch = bot.send_message(chat_id=message.chat.id, text='Ø§Ø±Ø³Ù„Øª Ù„Ùƒ Ø±Ù…Ø² ÙÙŠ Ù‡Ø§ØªÙÙƒ ğŸ“³. Ø§Ø±Ø³Ù„ Ø§Ù„Ø±Ù…Ø² ğŸ’¬')
        bot.register_next_step_handler(message_bitch, otp)
    else:
        bot.send_message(chat_id=message.chat.id, text='ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚. Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©')

def otp(message):
    if str(message.from_user.id) not in allowed_ids:
        return
    global access_token
    start_time = time.time()
    otb = message.text
    url = "https://ibiza.ooredoo.dz/auth/realms/ibiza/protocol/openid-connect/token"
    h = {
        "Content-Type": "application/x-www-form-urlencoded"
    }
    data2 = f'client_id=ibiza-app&otp={otb}&grant_type=password&mobile-number={mobile_number}&language=EN'

    try:
        res2 = requests.post(url, data=data2, headers=h).json()
    except requests.RequestException as e:
        logging.error(f"Error sending OTP request: {e}")
        bot.send_message(chat_id=message.chat.id, text='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.')
        return

    access_token = res2.get('access_token')

    if access_token:
        bot.reply_to(message, 'Ø§Ù„Ø±Ù…Ø² ØµØ­ÙŠØ­ âœ… Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØªØ¹Ø¨Ø¦Ø©')
        count_reference = 0
        m = 0
        headers = {
            'Authorization': f'Bearer {access_token}',
            'language': 'AR',
            'request-id': '3e3ec5a9-719f-45fb-a8e6-e213f80f2ff6',
            'flavour-type': 'gms',
            'Content-Type': 'application/json; charset=utf-8',
            'Host': 'ibiza.ooredoo.dz'
        }
        json_data = {"mgmValue": "ABC"}
        value = requests.get('https://ibiza.ooredoo.dz/api/v1/mobile-bff/users/balance', headers=headers).json()['accounts'][1]['value']

        while True:
            m += 1
            response = requests.post('https://ibiza.ooredoo.dz/api/v1/mobile-bff/users/mgm/info/apply', headers=headers, json=json_data).text
            if 'Ù…Ø±Ø¬Ø¹' in response:
                count_reference += 1
            if m == 6 or time.time() - start_time > 8:
                break

        value1 = requests.get('https://ibiza.ooredoo.dz/api/v1/mobile-bff/users/balance', headers=headers).json()['accounts'][1]['value']
        bot.send_message(chat_id=message.chat.id, text=f"""<strong> ØªÙ…Øª Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…ğŸ›œ
Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø¢Ù† Ù‡Ùˆ : {value1}
Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø¥Ø±Ø³Ø§Ù„ : {count_reference}
Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ 1 Ø¬ÙŠØ¬Ø§Ø¨Ø§ÙŠØª ÙÙ‚Ø· Ø§Ù†ØªØ¸Ø± Ù„Ù„Ø²ÙŠØ§Ø¯Ø©
ğŸ’¯
Dev @KARIM_Dz35</strong>""", parse_mode='html')
    else:
        bot.reply_to(message, '')

@app.route('/')
def home():
    return "<b>telegram @real_klamust</b>"

def run():
    app.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run)
    t.start()

def scheduled_stop():
    time.sleep(10 * 3600)  # Ø§Ù„Ø¨ÙˆØª Ø³ÙŠØ¹Ù…Ù„ Ù„Ù…Ø¯Ø© 10 Ø³Ø§Ø¹Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆÙ‚Ù
    bot.stop_polling()

if __name__ == "__main__":
    keep_alive()
    t = Thread(target=scheduled_stop)
    t.start()
    bot.infinity_polling(skip_pending=True
